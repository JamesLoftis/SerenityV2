# Serenity V2

A monitoring and observability platform that connects Tiller financial data in Google Sheets to Grafana for visualization. Built with OpenTofu for infrastructure as code and Docker Compose for easy deployment.

## Overview

Serenity V2 provides a comprehensive financial monitoring solution with:
- **Tiller** for automatic bank transaction import to Google Sheets
- **Grafana** with Google Sheets plugin for live financial dashboards
- **OpenTofu** for declarative infrastructure as code
- **Docker Compose** for one-command deployment
- **Kiosk Mode** for always-on displays

## Quick Start

### Prerequisites
- Docker and Docker Compose installed
- Google Cloud Platform account
- Tiller subscription with Google Sheets integration

### Initial Setup

#### Step 1: Set Up Google Cloud Platform
1. **Create/Select a GCP Project:**
   - Go to [Google Cloud Console](https://console.cloud.google.com/)
   - Create a new project or select existing one
   - Note your project ID

2. **Enable Google Sheets API:**
   - In GCP Console, go to "APIs & Services" → "Library"
   - Search for "Google Sheets API" and enable it

3. **Create Service Account:**
   - Go to "APIs & Services" → "Credentials"
   - Click "Create Credentials" → "Service Account"
   - Name it `serenity-grafana` 
   - Download the JSON key file
   - Note the service account email (e.g., `serenity-grafana@your-project.iam.gserviceaccount.com`)

#### Step 2: Configure Tiller Sheet Access
1. **Find Your Sheet ID:**
   - Open your Tiller Google Sheet
   - Copy the Sheet ID from URL: `docs.google.com/spreadsheets/d/{SHEET_ID}/edit`
   - Example: `1xYourGoogleSheetIdABC`

2. **Share Sheet with Service Account:**
   - In your Tiller sheet, click "Share" button
   - Add the service account email with "Viewer" permission
   - Send invitation

#### Step 3: Configure Serenity V2
Choose **Method A** (Environment Variables) OR **Method B** (Terraform Variables):

**Method A: Environment Variables (Recommended)**
```bash
# Copy environment template
cp env.example .env

# Edit .env with your values:
# GDRIVE_SA_EMAIL=serenity-grafana@your-project.iam.gserviceaccount.com
# GDRIVE_SA_PRIVATE_KEY=-----BEGIN PRIVATE KEY-----\nYOUR_FULL_PRIVATE_KEY\n-----END PRIVATE KEY-----\n
# SHEET_ID=1xYourGoogleSheetIdABC
```

**Method B: Terraform Variables (Alternative)**
```bash
cd tofu
cp terraform.tfvars.example terraform.tfvars

# Edit terraform.tfvars with your values:
# sheet_id = "1xYourGoogleSheetIdABC"
# gdrive_sa_email = "serenity-grafana@your-project.iam.gserviceaccount.com"
# gdrive_sa_private_key = "-----BEGIN PRIVATE KEY-----\nYOUR_FULL_PRIVATE_KEY\n-----END PRIVATE KEY-----\n"

cd ..
```

#### Step 4: Deploy and Access
```bash
# Start all services
docker compose up

# Access Grafana at http://localhost:3000
# No login required (anonymous access enabled for kiosk mode)
```

#### Step 5: Verify Setup
- Check that dashboard loads without errors
- Verify data appears in "Total Balance" panel
- Confirm transaction table shows recent data
- For kiosk displays, use: `http://localhost:3000/d/serenity-overview/serenity-overview?kiosk=tv&refresh=30s`

### Troubleshooting Initial Setup
- **"No data" in dashboard:** Verify service account has access to sheet and Sheet ID is correct
- **"Authentication failed":** Check private key format (preserve `\n` newlines)
- **Plugin errors:** Wait 2-3 minutes for Grafana to download Google Sheets plugin on first run

## Kiosk Usage

Point your displays/tablets to:
```
http://<host>:3000/d/serenity-overview/serenity-overview?kiosk=tv&refresh=30s
```

## Architecture

This approach keeps dashboards and datasources as **disposable infrastructure**:

1. **OpenTofu** generates Grafana provisioning files from code
2. **Grafana** reads live data directly from Google Sheets via plugin
3. **Tiller** automatically updates the sheet with fresh bank data
4. Everything is stateless - blow away containers and rebuild identically

## Directory Structure

```
SerenityV2/
├─ compose.yml              # Docker services (Tofu + Grafana)
├─ env.example              # Google service account template
├─ tofu/                    # OpenTofu infrastructure code
│  ├─ main.tf              # Generates Grafana provisioning files
│  ├─ outputs.tf           # Output definitions
│  └─ variables.tf         # Sheet ID and service account vars
├─ out/                    # Generated by OpenTofu (mounted into Grafana)
│  ├─ provisioning/
│  │  ├─ datasources/datasource.yaml      # Google Sheets datasource
│  │  └─ dashboards/
│  │     ├─ dashboards.yaml               # Dashboard provider config
│  │     └─ serenity_overview.json        # Financial overview dashboard
└─ README.md              # This file
```

## Tiller + Google Sheets Setup

### Secure Approach (Recommended)

1. **Create GCP Service Account:**
   - Enable Google Sheets API in your GCP project
   - Create service account: `serenity-grafana@your-project.iam.gserviceaccount.com`
   - Download JSON key

2. **Share Tiller Sheet:**
   - Open your Tiller Google Sheet
   - Share with service account email (Viewer permission)
   - Copy the Sheet ID from URL: `docs.google.com/spreadsheets/d/{SHEET_ID}/edit`

3. **Configure Environment:**
   ```bash
   # .env file
   GDRIVE_SA_EMAIL=serenity-grafana@your-project.iam.gserviceaccount.com
   GDRIVE_SA_PRIVATE_KEY=-----BEGIN PRIVATE KEY-----\nYOUR_KEY_HERE\n-----END PRIVATE KEY-----\n
   ```

### Testing Approach (Public Sheets)

For testing only, you can publish sheets as CSV:
- File → Share → "Publish to web" → CSV format
- Use Infinity datasource with CSV URLs
- **Don't use this for real financial data**

## Dashboard Features

The **Serenity Financial Overview** provides comprehensive insights across 7 panels:

### **Top Row - Key Metrics (4 panels)**
- **Net Worth**: Current total with color-coded thresholds 
- **This Month Spending**: Real-time spending alerts
- **Cash & Checking**: Liquid account balances  
- **Budget Status**: Monthly budget utilization percentage

### **Second Row - Analysis (2 panels)**
- **Net Worth Trend**: 90-day historical chart with statistics
- **Spending by Category**: Interactive pie chart for current month

### **Bottom Row - Detail (1 panel)**
- **Recent Transactions**: Last 30 days with sorting and formatting

**Data Sources**: Connects to standard Tiller sheets (`Balance History`, `Transactions`, `Accounts`, `Monthly Budget`, `Categories`) with 5-minute auto-refresh and proper currency formatting.

### Customizing Dashboards

Edit the dashboard definition in `tofu/main.tf` under `local.serenity_dashboard`:

- Modify panel queries to match your sheet structure
- Add new panels for categories, budgets, etc.
- Change time ranges and visualization types
- Update sheet ranges (e.g., `"Balances!B2:B999"`)

After changes, restart the compose stack:
```bash
docker compose down
docker compose up
```

## Operational Notes

### Daily Operations
After initial setup, normal usage is simply:
```bash
docker compose up    # Start services
docker compose down  # Stop services
```

### Adding New Dashboards
1. Add dashboard definitions to `tofu/main.tf`
2. Add corresponding `local_file` resources
3. Restart: `docker compose restart`

### Security for Production
- Disable anonymous auth: remove `GF_AUTH_ANONYMOUS_*` env vars
- Create dedicated viewer user for kiosk displays
- Use reverse proxy with IP allowlist if needed
- Rotate service account keys periodically

### Backup Strategy
- **Source of truth:** This repo + your Tiller Google Sheet
- **Grafana state:** Ephemeral by design (dashboards regenerated from code)
- **Historical data:** Lives in Tiller sheet, automatically backed up by Google

### Troubleshooting

**Plugin installation slow:** Grafana downloads plugins on first boot (~2 minutes). Subsequent starts are fast.

**Private key errors:** Ensure `\n` escapes are preserved in the environment variable. The Terraform `replace()` function handles conversion.

**Large sheets:** If transactions exceed ~50k rows, create aggregation tabs for Grafana to read instead of raw transaction data.

**No data showing:** Check that:
- Service account has access to the sheet
- Sheet ID is correct
- Range names match your Tiller sheet structure

## Advanced Configuration

### Sheet Structure

Tiller typically creates these tabs that you can reference:
- `Balances` - Account balances by date
- `Transactions` - All transaction details
- `Categories` - Spending by category
- `Monthly Budget` - Budget vs actual

Update the dashboard queries in `tofu/main.tf` to match your specific ranges.

### Custom Panels

The enhanced dashboard already includes comprehensive panels like spending by category and account balances. Add more to track:

- Investment performance and portfolio allocation
- Income vs expense trends over time  
- Cash flow projections and savings goals
- Custom budget categories and alerts
- Cash flow projections (stat panels)

### Environment Variables

Beyond the required service account vars, you can add:
- `TF_VAR_sheet_id` - Set sheet ID via environment
- Custom Grafana plugins via `GF_INSTALL_PLUGINS`
- Theme and branding options

## Support

For issues and feature requests, please check the project repository.

**Key Benefits:**
- ✅ **Always fresh data** - Direct connection to live Tiller sheets
- ✅ **Stateless infrastructure** - Reproducible deployments
- ✅ **Kiosk-ready** - Perfect for always-on displays
- ✅ **Version controlled dashboards** - Infrastructure as code
- ✅ **One-command deployment** - `docker compose up`